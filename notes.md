[TOC]

# 1. Introduction

> **Portfolio optimization** is the process of selecting the best portfolio (asset distribution), out of the set of all portfolios being considered, according to some objective. 

The objective typically maximizes factors such as the *expected return*, and minimized costs like *financial risk*. These factors could be:

- tangible, like assets, liabilities, earning or other **fundamentals**.
- intangible, like selective divestment.

## 1.1 Modern Portfolio Theory

The modern portfolio theory was introduced in 1952 by Markowitz, with the [*Markowitz model*](https://en.wikipedia.org/wiki/Utility_maximization_problem). It assumes that an investor wants to maximize a portfolio's expected  return contingent on any given amount of risk. For portfolios that meet  this criterion, known as efficient portfolios, achieving a higher  expected return requires taking on more risk, so investors are faced  with a trade-off between risk and expected return. This risk-expected return relationship of efficient portfolios is graphically represented  by a curve known as the efficient frontier. 

### 1.1.1 Efficient frontier

A portfolio is referred to as efficient if it has the best possible expected level of return for its level of risk, conveniently represented by the standard deviation of the portfolio's return. Here, every possible combination of risky assets can be plotted in risk-expected return space, and the collection of all such possible portfolios defines a region in this space. In the absence of the opportunity to hold a risk-free asset, this region is the opportunity set (the **feasible set)**. The positively sloped top boundary of this region is a portion of a hyperbola and is called the efficient frontier.

![img](https://upload.wikimedia.org/wikipedia/commons/e/e1/Markowitz_frontier.jpg)

If a risk-free asset is also available, the opportunity set is larger, and its upper boundary, the efficient frontier, is a straight line  segment emanating from the vertical axis at the value of the risk-free  asset's return and tangent to the risky-assets-only opportunity set. All portfolios between the risk-free asset and the tangency portfolio are  portfolios composed of risk-free assets and the tangency portfolio,  while all portfolios on the linear frontier above and to the right of  the tangency portfolio are generated by borrowing at the risk-free rate and investing the proceeds into the tangency portfolio.

### 1.1.2 Optimization methods

The portfolio optimization problem can be specified as a [**constrained utility-maximization problem**](https://en.wikipedia.org/wiki/Utility_maximization_problem). In such problems exists a formulation for the utility functions, commonly it the difference of the expected portfolio return (net of transaction and financing costs) minus a cost of risk.  The latter component, is defined as the portfolio risk multiplied by a **risk aversion** parameter, or unit price of risk. Often some constraints to improve diversification could be added, such as asset, sector, and region portfolio weight limits.

The optimization process takes place in two stages:

1. optimizing weights of asset classes to hold, i.e., choosing the proportions placed in equities versus bonds.
2. optimizing weights of assets within the same asset class, i.e., choosing the proportions of the stock sub-portfolio placed in stocks X, Y, Z. 

Investors are exposed to two types of risk: *unsystematic risk* and *systematic risk*. Unsystematic risk is an assetâ€™s intrinsic risk which can be diversified away by owning a large number of assets. These risks do not present enough information about the overall risk of the entire portfolio. Systematic risk, or the portfolio risk, is the risk generally associated with the market which cannot be eliminated. 

Having different classes in a Portfolio provides some diversification. Using this 2-way procedure eliminates non-systematic risks both on the individual asset and the asset-class level.

> ### 1.1.2.1 Portfolio separation in mean-variance analysis
>
> Portfolios can be analyzed in a mean-variance framework, with every investor holding the portfolio with the lowest possible return variance consistent with that investor's chosen level of expected return (the so-called minimum-variance portfolio).
>
> Under mean-variance analysis, it can be shown that every minimum-variance portfolio given a particular expected return (that is, every efficient portfolio) can be formed as a combination of any two efficient portfolios.  If the investor's optimal portfolio has an expected return that is between the expected returns on two efficient benchmark portfolios, then that investor's portfolio can be characterized as consisting of positive quantities of the two benchmark portfolios.
>
> To see two-fund separation in a context in which no risk-free asset is available, where:
>
> - $\sigma^2$ is the portfolio's variance, defined as $\sigma^2 = X^T\Sigma X$ where $\Sigma$ is a positive definite covariance matrix of the individual assets returns.
> - $\mu$ is the expected return on the portfolio,
> - $r$ is a vector of expected returns on the available assets,
> - $X$ is a vector of amounts to be placed in the assets,
> - $W$ is the amount of wealth to be allocated in the portfolio.
>
> The problem of minimizing the portfolio return variance subject to a given level of expected portfolio return can be stated as
> $$
> \begin{aligned}
>         \min_X \quad & \sigma^2\\
>         \textrm{s.t.} \quad & X^Tr=\mu\\
>         & X^T\mathbf{1} = W
> \end{aligned}
> $$
> The Lagrangian for this constrained optimization problem is 
> $$
> \mathcal{L} = X^T\Sigma X + 2\lambda (\mu - X^Tr)+2\eta (W - X^T \mathbf{1})
> $$
> This can be solved for the optimal vector $X$ of asset quantities by equating to zero the derivatives with respect to $X$, $\lambda$ and $\eta$. The result is 
> $$
> X^* = \alpha W + \beta \mu
> $$
>  where $\alpha$ and $\beta$ are parameter vector based on the underlying model parameters.

Markowitz has developed the *critical line method*, which is a general procedure for quadratic programming that can handle additional linear constraints and upper and lower bounds on holdings. In this context, the sudden approach provides a method for determining the entire set of efficient portfolios. 

### 1.1.3 Optimization Constraints

Portfolio optimization is usually done subject to constraints, such as regulatory constraints, or illiquidity. These constraints can lead to portfolio weights that focus on a small sub-sample of assets within the  portfolio. When the portfolio optimization process is subject to other constraints such as taxes, transaction costs, and management fees, the  optimization process may result in an under-diversified portfolio.

## 1.2 Improving Portfolio optimization

Different approaches to portfolio optimization measure risk differently. In addition to the traditional measure, which uses the standard deviation or the variance, which are not robust enough, one could use Sortino Ratio, CVaR, and statistical dispersion.

Investment is a forward-looking activity, and this the covariances of returns must be forecast rather than observed.

Portfolio optimization assumes the investor may have some risk aversion and the stock prices may exhibit significant differences between their historical or forecast values and what is experienced.  

# 2. The Critical Line Method

The gradient method works well for solving the *standard asset allocation problem*:
$$
\begin{aligned}
        \max_X \quad & u = \mu - \dfrac{\sigma^2}{rt}\\
        \textrm{s.t.} \quad & X^Tr=\mu\\
        & X^T\Sigma X=\sigma^2\\
        & X^T\mathbf{1} = W \\
        & X \geq lb \\
        & X \leq ub
\end{aligned}
$$
where $u$ is the measure of the portfolio's utility, which can be interpreted as a *risk-adjusted expected return,* computed by subtracting a risk penalty ($\frac{\sigma^2}{rt}$) from the expected return $\mu$.  Here, $rt$ represents the investor's *marginal rate of substitution of variance for expected value*.

Note that this involves the maximization of a *quadratic function* of the decision variables, subject to a set of *linear constraints*, some of which are *inequalities*. A problem with such characteristics is termed a *quadratic programming* (QP) problem. It may be solved with a general quadratic programming algorithm or with a procedure designed to deal only with problems that have similar structures. 

If there are no bounds on holdings, cases with additional linear constraints can be solved directly.  Markowitz developed a general procedure that can handle additional linear constraints and upper and lower bounds on holdings. Moreover, the approach provides a method for determining the entire set of efficient portfolios. 

## 2.1 Adding Linear Inequalities

The standard problem involves two sets of constraints. The first requires the sum of the proportions over $n$ assets to be equal to a constant:
$$
X^T\mathbf{1} = \sum x_i = W
$$
and the second to require that the proportions remain in some specified bounds:
$$
	\forall i \in \{1, \dots, n\}: x_i \geq lb \land x_i \leq ub
$$
We can generalize the first constraint to allow for any desired number of constraints as long as they are linear in the variables. Given such $m$ constraints, we require that:
$$
Ax = b
$$
where $A \in \R^{m \times n}$ is a matrix with the left-hand side coefficients of the constraints and $b \in \R^{m}$ is a vector of the right-hand sides of the constraints. The **full-investment constraints**, $W = 1$, requires that $m = 1$ and all the coefficients in $A$ and $b$ are equal to $1.0$. 

Linear equality constraints may be of some interest in their own right, but in most practical cases they are not. By combining a linear equality with bounds on a variable one can constrain a linear function of the asset holdings to be within desired bounds.

To illustrate, consider a 3 asset case in which the maximum weight to be invested in cash plus bonds to $40%$ of the overall portfolio. To do so, we introduce a new variable to represent the sum of the amounts, so $X_4 = X_1 + X_2$, and add a second equation to the constraint set:

```
A = [1	1	1	0
	 1	1	0  -1]
b = [1
	 0]
```

In the first, the full-investment constraint, the fourth variable has coefficient zero, since it is not an investment per se. To restrict the amount invested in the sum of the two asset classes to be less than 40% of the portfolio, we need only to assign the appropriate values for the bounds on variable 4. In this case:

```
lb = [0
	  0
	  0
	  0]
	  
lb = [1
	  1
	  1
	  0.4]
```

## 2.2 Parametric General Asset Allocation Problem

The parametric general asset allocation problem has the form, for all positive values of $rt$:
$$
\begin{aligned}
        \max_X \quad & u = \mu - \dfrac{\sigma^2}{rt}\\
        \textrm{s.t.} \quad & X^Tr=\mu\\
        & X^T\Sigma X=\sigma^2\\
        & X^T\mathbf{1} = W \\
        & Ax = b \\
        & X \geq lb \\
        & X \leq ub \\
\end{aligned}
$$
The solution to the parametric version will be a matrix of portfolios rather than a single portfolio, by varying the values of $rt$. 

To illustrate, consider a portfolio where the assets are cash, bonds and stocks, with expected returns, risks and correlations:

```
    mean =
        2.8000
        6.3000
       10.8000

    standard_deviation =
        1.0000
        7.4000
       15.4000

    correlations =
        1.0000    0.4000    0.1500
        0.4000    1.0000    0.3500
        0.1500    0.3500    1.0000
```

We assume that is required that at least $20\%$ of the portfolio be invested in each of the assets and that no more than $50\%$ of the portfolio be invested in any asset. Thus:

```
lb =
    0.2000
    0.2000
    0.2000

ub =
    0.5000
    0.5000
    0.5000
```

Then we have to find all the portfolios which are efficient by maximizing the utility for every non-negative value of the risk tolerance.


### 2.2.1 Maximum Expected Return

Modern portfolio theory assumes that for a given level of risk, a rational investor wants the maximal return, and for a given level of expected return, the investor wants the minimal risk. Here, we are considering the case when the investor decides to maximize expected return by disregarding risk:
$$
\begin{aligned}
        \max \quad & \mu\\
        \textrm{where} \quad & rt \rightarrow \infty\\
        \textrm{s.t.} \quad & X^Tr=\mu\\
            & X^T\mathbf{1} = W \\
                    & Ax = b \\

            & X \geq lb \\
            & X \leq ub \\
\end{aligned}
$$
This is a **linear programming problem**, since all the constraints are linear and the objective function is linear.  Obviously it is the same as minimizing the negative expected valued of the portfolio. This could be solved by using general linear programming algorithms.

## 2.3 Optimal Portfolio with Fixed Risk Tolerance

Suppose now we have to found an optimal portfolio with a fixed risk tolerance of *$45$*. To find an answer we might guess that the status of each variable in such a case would be the same as in the solution for $rt = \infty$ . Assume that this is true. The solution equation for the case in which no bounds are binding, where $y \in \R^{n+1}$ , whose last variable of it is a $tmup$ unknown value, and $D \in \R^{n+1 \times n+1}$ element matrix that includes the information about asset covariances and the constraint that the sum of the holding equals a constant:
$$
Dy = k +rt*f
$$
where $k$ is the vector that indicates the full-investment constrain on row $n+1$, and $f$ is a vector that contains the asset expected return in the first $n$ rows and zero for the $n+1$ one. Then

| 2*C(1,1) | 2*C(1,2) | 2*C(1,3) | 1    |      | x(1) |      | 0    |      |      | e(1) |
| -------- | -------- | -------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 2*C(2,1) | 2*C(2,2) | 2*C(2,3) | 1    | *    | x(2) | =    | 0    | +    | rt   | e(2) |
| 2*C(3,1) | 2*C(3,2) | 2*C(3,3) | 1    |      | x(3) |      | 0    |      |      | e(3) |
| 1        | 1        | 1        | 0    |      | tmup |      | 1    |      |      | 0    |

The first equation is derived by setting the derivative of the Lagrangian function with respect to the first variable equal to zero. The second equation is derived by doing so with respect to the second variable. And so on, for the first *n* equations. These *first-order condition* equations remain appropriate for the variables that are in the solution, for their bounds are not binding and hence could have been omitted entirely. Note, however, that the corresponding equations will not generally hold for variables that are down or up. On the other hand, it is easy to write an equation for any such variable, since it must be at the corresponding bound. In the case at hand we need to replace the first equation with one that states:
$$
X_1 = lb_1
$$
 and the third:
$$
X_3 = ub_3
$$
This is easily done by modifying $D$, $k$ and $f$ to give:
$$
DDy = kk + rt*ff
$$
where the new matrices and vectors are:

| 1        | 0        | 0        | 0    |      | x(1) |      | 0.20 |      |      | 0    |
| -------- | -------- | -------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 2*C(2,1) | 2*C(2,2) | 2*C(2,3) | 1    | *    | x(2) | =    | 0    | +    | rt   | e(2) |
| 0        | 0        | 1        | 0    |      | x(3) |      | 0.50 |      |      | 0    |
| 1        | 1        | 1        | 0    |      | tmup |      | 1    |      |      | 0    |

We can now solve the system of equations:
$$
y = DD^{-1}kk + rt*DD^{-1}ff
$$
The optimal portfolio is the same for someone with a risk tolerance of $45 $ as for someone who doesn't care at all about risk!

## 2.4 The Kuhn-Tucker Conditions

The goal is to maximize portfolio utility, stated in expected return equivalent terms:
$$
u = \mu - \dfrac{\sigma^2}{rt}
$$
This can be also stated in a variance equivalent terms:
$$
u_v = rt\mu - \sigma^2
$$
And we have to meet one or more linear equality constraints:
$$
Ax = b
$$
and in order to obtain a feasible solution we require that: 
$$
b - Ax = \mathbf{0}
$$
We form now the Lagrangian associated, where where $A_i = row(A, i)$ :
$$
\mathcal{L} = rt\mu - \sigma^2 + \lambda(b_1-A_{1}X) + \eta(b_2-A_{2}X)
$$
Then we have to compute the derivatives with respect to the asset holdings and then setting these to zero to satisfy the first-order conditions:
$$
\frac{d\mathcal{L}}{dX_i} = rt *\mu_i - 2\Sigma_{i}X - \lambda A_{1i} - \eta A_{2i} \quad \textrm{with}\quad i \in \{1,\dots,n\}
$$

$$
\frac{d\mathcal{L}}{dX_i} = 0 \Rightarrow 2\Sigma_{i}X = 0 + rt*\mu_i
$$

The derivative with respect to the Lagrange multipliers are:
$$
\begin{align}
	& \quad \frac{d\mathcal{L}}{d\lambda} = b_1 - A_{1}X \\
	& \quad \frac{d\mathcal{L}}{d\eta} = b_2 - A_{2}X
\end{align}
$$
and setting these to zero give us the original constraint equations:
$$
\begin{align}
	& \quad b_1 - A_{1}X = 0 \Rightarrow A_1X = b_1\\
	& \quad b_2 - A_{2}X = 0 \Rightarrow A_2X = b_2
\end{align}
$$
We have now $3+2$ equations in $5$ unknows. this could be written as before as:
$$
D*y = k + rt*f
$$
where
$$
D = \begin{bmatrix}
2\Sigma & A^T \\
A & \mathbf{0}^{m \times m} 
\end{bmatrix}
$$

$$
k = \begin{bmatrix}
\mathbf{0}^{n}  \\
b  
\end{bmatrix}
$$

$$
f = \begin{bmatrix}
\mu \\
\mathbf{0}^{m} 
\end{bmatrix}
$$

In CLA the goal is to maximize a Lagrangian function:
$$
\mathcal{L} = rt*\mu - \sigma^2 + \lambda(b_1 - A_{1}X)
$$
The partial derivative of $\mathcal{L}$ with respect to $X_i$ is
$$
\frac{d\mathcal{L}}{dX_i} = rt *\mu_i - 2\Sigma_{ij}
$$
Since we wish to maximize $\mathcal{L}$, the goal is to get to the top of the hill where the height is given by the value of the function and the coordinates are given by $X$ plus $\lambda$, $\eta$. 

Consider $\dfrac{d\mathcal{L}}{dX_i}$ in the $X_i$ direction when at the optima point. If $X_i$ is a **in-variable**, namely if $lb_i \leq X_i \leq ub_i$, the slope must zero or else we would not in fact be at the top of the feasible hill. Thus we have:
$$
\frac{d\mathcal{L}}{dX_i} = 0
$$
for all in-variables. Now consider $\dfrac{d\mathcal{L}}{dX_i}$ at the optimal point for a **down-variable**, namely if   $lb_i = X_i$. If this were positive, we could not be at the top of feasible hill since an increase in $X_i$ would improve the solution. However, it could be negative, indicating that a further decrease would lead to a higher value of $\mathcal{L}$, but this increase is not allowed, thus:
$$
\frac{d\mathcal{L}}{dX_i} \leq 0
$$
for all down-variables. It must be the case that the derivative is zero or positive for all **up-variables**, namely if $X_i = ub_i$. If such a slope were negative, it would pay to decrease the value of the variable, since by doing so one could reach a higher position, then:
$$
\frac{d\mathcal{L}}{dX_i} \geq 0
$$
for all up-variables. This are the *Kuhn-Tucker conditions* to be met. 

### 2.4.1 Computing derivatives wrt to Bounded Variables

As before the Lagrangian:
$$
\mathcal{L} = rt*\mu - \sigma^2 + \lambda(b_1 - A_{1}X)
$$
the derivative is:
$$
\frac{d\mathcal{L}}{dX} = rt*\mu - 2\Sigma X - \lambda = rt*f - D*y
$$
where the first $n$ elements of are the derivatives of the Lagrangian with respect to the asset holdings. Now we have to verify that the Kuhn-Tucker conditions have been met, namely that:

1. for a down-variable a negative value,
2. for a in-variable a zero,
3. for a up-variable a positive value.v

